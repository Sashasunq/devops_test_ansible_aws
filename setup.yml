---
  - name: Provision an EC2 Instance
    connection: local
    hosts: localhost
    gather_facts: False

    # Necessary Variables for creating/provisioning the EC2 Instance
    vars:
      security_group: test
      region:  us-east-1
      instance_type: t2.micro
      image: ami-00bbb68c7e6ca73ce
      keypair: main
      count: 2
      vpc_name: main
      vpc_key: main
      vpc_dns_zone: ansible-vpc
      vpc_cidr_block: 10.0.0.0/16
      vpc_cidr: 10.0.1.0/24
      vpc_az: "{{ region }}a"

      tasks:
        - name: Create default VPC
          ec2_vpc_net:
            name: "{{ vpc_name }}"
            cidr_block: "{{ vpc_cidr_block }}"
            region: "{{ region }}"
          register: create_vpc
          tags: vpc

        - name: "Set fact: VPC ID"
          set_fact:
            vpc_id: "{{ create_vpc.vpc.id }}"
          tags: vpc

        - name: Ð¡reate VPC subnet
          ec2_vpc_subnet:
            vpc_id: "{{ vpc_id }}"
            cidr: "{{ vpc_cidr }}"
            az: "{{ vpc_az }}"
            region: "{{ region }}"
            map_public: yes
            tags:
              Name: "{{ vpc_name }}"
          register: create_vpc_subnet
          tags: vpc
